<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image to Link Cropper (16:9)</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #222; color: #eee; }
    canvas { border: 1px solid #444; display: block; margin: 0 auto; background: #000; cursor: default; }
    #controls { margin-top: 12px; }
    button, select { margin: 5px; padding: 6px 12px; cursor: pointer; }
    #warning { margin-top: 10px; color: #ffcc00; font-size: 14px; }
    #previewArea { margin-top: 20px; }
    #previewArea img { border: 1px solid #555; max-width: 100%; height: auto; }
    #copiedMsg, #uploadedMsg { margin-top: 8px; font-size: 14px; display: none; }
    #copiedMsg { color: #66ff66; }
    #uploadedMsg { color: #00ccff; }
  </style>
</head>
<body>
  <h1>📷 Image to Link Cropper (16:9)</h1>
  <input type="file" id="fileInput" accept="image/*"><br><br>

  <label for="mode">Mode: </label>
  <select id="mode">
    <option value="crop">Crop</option>
    <option value="fit">Fit to Frame</option>
  </select>

  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="previewBtn" disabled>Preview Export</button>
    <button id="downloadBtn" disabled>Download PNG</button>
    <button id="copyLinkBtn" disabled>Copy Image Link</button>
    <button id="uploadBtn" disabled>Upload & Get Short Link</button>
  </div>

  <div id="warning"></div>
  <div id="previewArea"></div>
  <div id="copiedMsg">✅ Image link copied to clipboard!</div>
  <div id="uploadedMsg">✅ Uploaded! Link: <a id="shortLink" href="#" target="_blank"></a></div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const modeSelect = document.getElementById("mode");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const previewBtn = document.getElementById("previewBtn");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const warningDiv = document.getElementById("warning");
    const previewArea = document.getElementById("previewArea");
    const copiedMsg = document.getElementById("copiedMsg");
    const uploadedMsg = document.getElementById("uploadedMsg");
    const shortLink = document.getElementById("shortLink");

    let img = new Image();
    let mask = { x: 0, y: 0, w: 0, h: 0 };
    let dragging = false, resizing = false;
    let dragStartX, dragStartY, handle = null;
    let currentMode = "crop";

    const MAX_SIZE = 4096;
    const MIN_W = 50;
    const MIN_H = MIN_W * 9/16;
    const EXPORT_W = 1280;
    const EXPORT_H = 720;

    function initMask() {
      const iw = canvas.width, ih = canvas.height;
      if (iw / ih > 16/9) {
        const mh = ih * 0.8;
        const mw = mh * 16/9;
        mask = { w: mw, h: mh, x: (iw - mw)/2, y: (ih - mh)/2 };
      } else {
        const mw = iw * 0.8;
        const mh = mw * 9/16;
        mask = { w: mw, h: mh, x: (iw - mw)/2, y: (ih - mh)/2 };
      }
    }

    function clampMask() {
      if (mask.w < MIN_W) { mask.w = MIN_W; mask.h = MIN_H; }
      if (mask.h < MIN_H) { mask.h = MIN_H; mask.w = MIN_W; }
      if (mask.x < 0) mask.x = 0;
      if (mask.y < 0) mask.y = 0;
      if (mask.x + mask.w > canvas.width) mask.x = canvas.width - mask.w;
      if (mask.y + mask.h > canvas.height) mask.y = canvas.height - mask.h;
    }

    function drawScene() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (currentMode === "crop") {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Overlay
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.beginPath();
        ctx.rect(0, 0, canvas.width, canvas.height);
        ctx.moveTo(mask.x, mask.y);
        ctx.rect(mask.x, mask.y, mask.w, mask.h);
        ctx.fill("evenodd");

        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        ctx.strokeRect(mask.x, mask.y, mask.w, mask.h);

        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = "yellow";
        for (let i = 1; i < 3; i++) {
          ctx.beginPath();
          ctx.moveTo(mask.x + (mask.w * i) / 3, mask.y);
          ctx.lineTo(mask.x + (mask.w * i) / 3, mask.y + mask.h);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(mask.x, mask.y + (mask.h * i) / 3);
          ctx.lineTo(mask.x + mask.w, mask.y + (mask.h * i) / 3);
          ctx.stroke();
        }
        ctx.setLineDash([]);

        // Handles
        ctx.fillStyle = "red";
        getHandles().forEach(h => ctx.fillRect(h.x-4, h.y-4, 8, 8));
      } else {
        ctx.fillStyle = "black";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
        const iw = img.width * scale;
        const ih = img.height * scale;
        const ix = (canvas.width - iw)/2;
        const iy = (canvas.height - ih)/2;
        ctx.drawImage(img, ix, iy, iw, ih);
      }
    }

    function getHandles() {
      return [
        {name:"tl", x:mask.x, y:mask.y, cursor:"nwse-resize"},
        {name:"tr", x:mask.x+mask.w, y:mask.y, cursor:"nesw-resize"},
        {name:"bl", x:mask.x, y:mask.y+mask.h, cursor:"nesw-resize"},
        {name:"br", x:mask.x+mask.w, y:mask.y+mask.h, cursor:"nwse-resize"},
        {name:"tm", x:mask.x+mask.w/2, y:mask.y, cursor:"ns-resize"},
        {name:"bm", x:mask.x+mask.w/2, y:mask.y+mask.h, cursor:"ns-resize"},
        {name:"ml", x:mask.x, y:mask.y+mask.h/2, cursor:"ew-resize"},
        {name:"mr", x:mask.x+mask.w, y:mask.y+mask.h/2, cursor:"ew-resize"}
      ];
    }

    function hitHandle(mx,my) {
      return getHandles().find(h =>
        mx >= h.x-6 && mx <= h.x+6 && my >= h.y-6 && my <= h.y+6
      );
    }

    function resizeIfNeeded(image) {
      if (image.width <= MAX_SIZE && image.height <= MAX_SIZE) {
        warningDiv.textContent = "";
        return image;
      }
      const scale = Math.min(MAX_SIZE / image.width, MAX_SIZE / image.height);
      const newW = Math.round(image.width * scale);
      const newH = Math.round(image.height * scale);
      const tmpCanvas = document.createElement("canvas");
      tmpCanvas.width = newW;
      tmpCanvas.height = newH;
      tmpCanvas.getContext("2d").drawImage(image, 0, 0, newW, newH);
      const resized = new Image();
      resized.src = tmpCanvas.toDataURL("image/png");
      warningDiv.textContent = `⚠️ Image resized to ${newW}×${newH}`;
      return resized;
    }

    function renderExportCanvas() {
      const cropCanvas = document.createElement("canvas");
      cropCanvas.width = EXPORT_W;
      cropCanvas.height = EXPORT_H;
      const ctx2 = cropCanvas.getContext("2d");
      if (currentMode === "crop") {
        ctx2.drawImage(img, mask.x, mask.y, mask.w, mask.h, 0, 0, EXPORT_W, EXPORT_H);
      } else {
        ctx2.drawImage(canvas, 0, 0, EXPORT_W, EXPORT_H);
      }
      return cropCanvas;
    }

    // File input
    fileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const raw = new Image();
        raw.onload = () => {
          const resized = resizeIfNeeded(raw);
          resized.onload = () => {
            if (currentMode === "fit") {
              canvas.width = resized.width;
              canvas.height = Math.round(resized.width * 9/16);
            } else {
              canvas.width = resized.width;
              canvas.height = resized.height;
            }
            img = resized;
            initMask();
            drawScene();
            previewBtn.disabled = copyLinkBtn.disabled = downloadBtn.disabled = uploadBtn.disabled = false;
          };
          if (resized.complete && resized.naturalWidth > 0) resized.onload();
        };
        raw.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Mode switch
    modeSelect.addEventListener("change", e => {
      currentMode = e.target.value;
      if (img.src) {
        if (currentMode === "fit") {
          canvas.width = img.width;
          canvas.height = Math.round(img.width * 9/16);
        } else {
          canvas.width = img.width;
          canvas.height = img.height;
          initMask();
        }
        drawScene();
      }
    });

    // Crop interaction
    canvas.addEventListener("mousedown", e => {
      if (currentMode !== "crop") return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      const h = hitHandle(mx,my);
      if (h) { resizing = true; handle = h.name; }
      else if (mx >= mask.x && mx <= mask.x+mask.w && my >= mask.y && my <= mask.y+mask.h) {
        dragging = true; dragStartX = mx - mask.x; dragStartY = my - mask.y;
      }
    });

    canvas.addEventListener("mousemove", e => {
      if (currentMode !== "crop") return;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left, my = e.clientY - rect.top;
      const h = hitHandle(mx,my);
      canvas.style.cursor = h ? h.cursor :
        (mx >= mask.x && mx <= mask.x+mask.w && my >= mask.y && my <= mask.y+mask.h ? "move" : "default");
      if (dragging) { mask.x = mx - dragStartX; mask.y = my - dragStartY; clampMask(); drawScene(); }
      if (resizing) {
        let newW, newH;
        if (handle === "tm") { newH = (mask.y + mask.h) - my; newW = newH*16/9; mask.x += (mask.w-newW)/2; mask.y = my; }
        else if (handle === "bm") { newH = my-mask.y; newW = newH*16/9; mask.x += (mask.w-newW)/2; }
        else if (handle === "ml") { newW = (mask.x+mask.w)-mx; newH = newW*9/16; mask.y += (mask.h-newH)/2; mask.x = mx; }
        else if (handle === "mr") { newW = mx-mask.x; newH = newW*9/16; mask.y += (mask.h-newH)/2; }
        else { newW = (handle==="tl"||handle==="bl")?(mask.x+mask.w-mx):(mx-mask.x); newH = newW*9/16;
          if (handle==="tl"||handle==="tr") mask.y = mask.y+mask.h-newH;
          if (handle==="tl"||handle==="bl") mask.x = mask.x+mask.w-newW; }
        mask.w = newW; mask.h = newH; clampMask(); drawScene();
      }
    });
    canvas.addEventListener("mouseup", ()=>{dragging=resizing=false;});

    // Buttons
    previewBtn.addEventListener("click", () => {
      const exportCanvas = renderExportCanvas();
      const previewImg = new Image();
      previewImg.src = exportCanvas.toDataURL("image/png");
      previewArea.innerHTML = "<h3>Export Preview (1280×720)</h3>";
      previewArea.appendChild(previewImg);
    });

    downloadBtn.addEventListener("click", () => {
      const cropCanvas = renderExportCanvas();
      const link = document.createElement("a");
      link.download = "exported.png";
      link.href = cropCanvas.toDataURL("image/png");
      link.click();
    });

    copyLinkBtn.addEventListener("click", async () => {
      const cropCanvas = renderExportCanvas();
      try {
        await navigator.clipboard.writeText(cropCanvas.toDataURL("image/png"));
        copiedMsg.style.display="block"; setTimeout(()=>copiedMsg.style.display="none",2000);
      } catch (err) { alert("Failed to copy link: "+err); }
    });

    uploadBtn.addEventListener("click", async () => {
      const cropCanvas = renderExportCanvas();
      cropCanvas.toBlob(async (blob) => {
        const form = new FormData();
        form.append("reqtype", "fileupload");
        form.append("fileToUpload", blob, "export.png");
        try {
          const res = await fetch("https://catbox.moe/user/api.php",{method:"POST",body:form});
          const url = await res.text();
          shortLink.href=url; shortLink.textContent=url;
          uploadedMsg.style.display="block";
        } catch(err){ alert("Upload failed: "+err); }
      },"image/png");
    });
  </script>
</body>
</html>
