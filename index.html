<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image to Link Cropper (16:9)</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #222; color: #eee; }
    canvas { border: 1px solid #444; display: block; margin: 0 auto; background: #000; cursor: default; }
    #controls { margin-top: 12px; }
    button, select { margin: 5px; padding: 6px 12px; cursor: pointer; }
    #warning { margin-top: 10px; color: #ffcc00; font-size: 14px; }
    #previewArea { margin-top: 20px; }
    #previewArea img { border: 1px solid #555; max-width: 100%; height: auto; }
    #copiedMsg { margin-top: 8px; color: #66ff66; font-size: 14px; display: none; }
    #library { margin-top: 30px; text-align: left; max-width: 900px; margin-left: auto; margin-right: auto; }
    .lib-item { display: flex; align-items: center; background: #333; margin-bottom: 10px; padding: 8px; border-radius: 6px; }
    .lib-item img { width: 120px; height: auto; border: 1px solid #555; margin-right: 10px; }
    .lib-actions button { margin: 2px; }
    #storageUsage { font-size: 13px; margin: 4px 0 12px; color: #aaa; }
  </style>
</head>
<body>
  <h1>üì∑ Image to Link Cropper (16:9)</h1>
  <input type="file" id="fileInput" accept="image/*"><br><br>

  <label for="mode">Mode: </label>
  <select id="mode">
    <option value="crop">Crop</option>
    <option value="fit">Fit to Frame</option>
  </select>

  <canvas id="canvas"></canvas>

  <div id="controls">
    <button id="previewBtn" disabled>Preview Export</button>
    <button id="downloadBtn" disabled>Download PNG</button>
    <button id="copyLinkBtn" disabled>Copy Image Link</button>
    <button id="uploadBtn" disabled>Upload to Catbox</button>
  </div>

  <div id="warning"></div>
  <div id="previewArea"></div>
  <div id="copiedMsg">‚úÖ Image copied to clipboard!</div>

  <h2>üìö Export Library</h2>
  <button id="clearLibraryBtn">Clear All</button>
  <button id="addCatboxBtn">Add Catbox Link</button>
  <button id="exportLibraryBtn">Export Library</button>
  <input type="file" id="importLibraryInput" style="display:none;" accept=".json">
  <button id="importLibraryBtn">Import Library</button>
  <p id="storageUsage">üì¶ Storage used: 0 MB / ~5 MB</p>
  <div id="library"></div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const modeSelect = document.getElementById("mode");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const previewBtn = document.getElementById("previewBtn");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const warningDiv = document.getElementById("warning");
    const previewArea = document.getElementById("previewArea");
    const copiedMsg = document.getElementById("copiedMsg");
    const libraryDiv = document.getElementById("library");
    const clearLibraryBtn = document.getElementById("clearLibraryBtn");
    const addCatboxBtn = document.getElementById("addCatboxBtn");
    const exportLibraryBtn = document.getElementById("exportLibraryBtn");
    const importLibraryBtn = document.getElementById("importLibraryBtn");
    const importLibraryInput = document.getElementById("importLibraryInput");
    const storageUsage = document.getElementById("storageUsage");

    let img = new Image();
    let mask = { x: 0, y: 0, w: 0, h: 0 };
    let dragging = false, resizing = false;
    let dragStartX, dragStartY, handle = null;
    let currentMode = "crop";

    const MAX_SIZE = 4096;
    const MIN_W = 50;
    const MIN_H = MIN_W * 9/16;
    const EXPORT_W = 1280;
    const EXPORT_H = 720;

    // --- Library Functions ---
    function updateStorageUsage() {
      const libStr = localStorage.getItem("exportLibrary") || "[]";
      const bytes = new Blob([libStr]).size;
      const mb = (bytes / 1024 / 1024).toFixed(2);
      storageUsage.textContent = `üì¶ Storage used: ${mb} MB / ~5 MB`;
    }

    function enforceStorageLimit() {
      let lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      while (true) {
        const libStr = JSON.stringify(lib);
        const bytes = new Blob([libStr]).size;
        const mb = bytes / 1024 / 1024;
        if (mb < 4.5) break;
        lib.pop(); // remove oldest
      }
      localStorage.setItem("exportLibrary", JSON.stringify(lib));
      renderLibrary(lib);
      updateStorageUsage();
    }

    function saveToLibrary(dataUrl) {
      let lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      lib.unshift({ id: Date.now(), dataUrl, timestamp: new Date().toLocaleString() });
      localStorage.setItem("exportLibrary", JSON.stringify(lib));
      enforceStorageLimit();
    }

    function renderLibrary(lib) {
      libraryDiv.innerHTML = "";
      if (lib.length === 0) {
        libraryDiv.innerHTML = "<p>No exports saved yet.</p>";
        return;
      }
      lib.forEach(item => {
        const isCatbox = item.dataUrl.includes("catbox.moe");
        const isExternal = item.dataUrl.startsWith("http") && !isCatbox;

        let warningText = "";
        if (isExternal) {
          warningText = `<p style="color:#ffcc00; font-size:12px;">‚ö†Ô∏è This is an external image link. It may be larger in filesize.</p>`;
        }

        const div = document.createElement("div");
        div.className = "lib-item";
        div.innerHTML = `
          <img src="${item.dataUrl}">
          <div class="lib-info">
            <p><strong>${item.timestamp}</strong></p>
            ${warningText}
            <div class="lib-actions">
              <button onclick="copyFromLibrary('${item.id}')">Copy Link</button>
              ${isCatbox ? "" : `<button onclick="downloadFromLibrary('${item.id}')">Download</button>`}
              <button onclick="openFromLibrary('${item.id}')">Open</button>
              <button onclick="replaceLink('${item.id}')">Replace Link</button>
              <button onclick="deleteFromLibrary('${item.id}')">Delete</button>
            </div>
          </div>
        `;
        libraryDiv.appendChild(div);
      });
    }

    function copyFromLibrary(id) {
      const lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      const item = lib.find(i => i.id == id);
      if (!item) return;
      navigator.clipboard.writeText(item.dataUrl).then(() => {
        copiedMsg.textContent = "‚úÖ Library image link copied!";
        copiedMsg.style.display = "block";
        setTimeout(() => copiedMsg.style.display = "none", 2000);
      });
    }

    function downloadFromLibrary(id) {
      const lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      const item = lib.find(i => i.id == id);
      if (!item) return;
      const link = document.createElement("a");
      link.download = "exported.png";
      link.href = item.dataUrl;
      link.click();
    }

    function openFromLibrary(id) {
      const lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      const item = lib.find(i => i.id == id);
      if (item) window.open(item.dataUrl, "_blank");
    }

    function replaceLink(id) {
      const newLink = prompt("Enter Catbox (or image) URL to replace this link:");
      if (!newLink) return;
      let lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      const item = lib.find(i => i.id == id);
      if (item) {
        item.dataUrl = newLink;
        item.timestamp = new Date().toLocaleString() + " (Replaced)";
      }
      localStorage.setItem("exportLibrary", JSON.stringify(lib));
      renderLibrary(lib);
      updateStorageUsage();
    }

    function deleteFromLibrary(id) {
      let lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      lib = lib.filter(i => i.id != id);
      localStorage.setItem("exportLibrary", JSON.stringify(lib));
      renderLibrary(lib);
      updateStorageUsage();
    }

    clearLibraryBtn.addEventListener("click", () => {
      if (confirm("Clear all saved exports?")) {
        localStorage.removeItem("exportLibrary");
        renderLibrary([]);
        updateStorageUsage();
      }
    });

    addCatboxBtn.addEventListener("click", () => {
      const url = prompt("Enter a Catbox (or image) URL to add:");
      if (!url) return;
      if (!url.startsWith("http")) {
        alert("Please enter a valid link starting with http or https.");
        return;
      }
      let lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      lib.unshift({ id: Date.now(), dataUrl: url, timestamp: new Date().toLocaleString() + " (Imported)" });
      localStorage.setItem("exportLibrary", JSON.stringify(lib));
      renderLibrary(lib);
      updateStorageUsage();
    });

    // --- Export library with warning ---
    exportLibraryBtn.addEventListener("click", () => {
      const lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      const base64Count = lib.filter(item => item.dataUrl.startsWith("data:")).length;

      if (base64Count > 0) {
        const proceed = confirm(
          `‚ö†Ô∏è The library contains ${base64Count} images saved as base64.\n` +
          `This will increase filesize SIGNIFICANTLY.\n\n` +
          `üí° Suggestion: Replace base64 images with Catbox links before exporting to keep the file small.\n\n` +
          `Are you sure you want to export this library?`
        );
        if (!proceed) return;
      }

      const libStr = JSON.stringify(lib);
      const blob = new Blob([libStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "exportLibrary.json";
      link.click();
      URL.revokeObjectURL(url);
    });

    // --- Import library from JSON ---
    importLibraryBtn.addEventListener("click", () => {
      importLibraryInput.click();
    });

    importLibraryInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!Array.isArray(imported)) throw new Error("Invalid library file");

          let lib = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
          lib = imported.concat(lib);
          localStorage.setItem("exportLibrary", JSON.stringify(lib));
          enforceStorageLimit();
          alert("‚úÖ Library imported successfully!");
        } catch (err) {
          alert("‚ö†Ô∏è Failed to import library: " + err.message);
        }
      };
      reader.readAsText(file);
    });

    function loadLibrary() {
      const data = JSON.parse(localStorage.getItem("exportLibrary") || "[]");
      renderLibrary(data);
      updateStorageUsage();
    }
    loadLibrary();

    // --- Cropper / Editor code remains unchanged below ---
    // (‚Ä¶ keep your existing initMask, clampMask, drawScene, handles, resizeIfNeeded, renderExportCanvas, file input, crop interaction, and export buttons code ‚Ä¶)
  </script>
</body>
</html>
